name: Setup course infra
on:
  workflow_dispatch:
defaults:
  run:
    working-directory: ./infra
jobs:
  setup-infra:
    runs-on: ubuntu-latest
    permissions:
      contents: read
      id-token: write
    env:
      TF_VAR_gcp_region: europe-north1
      TF_VAR_gcp_zone: europe-north1-a
      TF_VAR_gcp_project: ${{ secrets.GCP_PROJECTID }}
    steps:
      - name: Harden runner
        uses: step-security/harden-runner@17d0e2bd7d51742c71671bd19fa12bdc9d40a3d6 # ratchet:step-security/harden-runner@v2
        with:
          disable-sudo: true
          egress-policy: audit
          allowed-endpoints: >
            dl.google.com:443
            github.com:443
            iamcredentials.googleapis.com:443
            raw.githubusercontent.com:443
            sts.googleapis.com:443
            api.github.com:443
            openidconnect.googleapis.com:443

      - uses: actions/checkout@692973e3d937129bcbf40652eb9f2f61becf3332 # ratchet:actions/checkout@v4
        with:
          persist-credentials: false

      - name: GCP auth
        uses: google-github-actions/auth@71fee32a0bb7e97b4d33d548e7d957010649d8fa # ratchet:google-github-actions/auth@v2
        with:
          workload_identity_provider: projects/${{ secrets.GCP_PROJECTID }}/locations/global/workloadIdentityPools/lf260-pool/providers/github
          service_account: ${{ secrets.GCP_SERVICEUSER }}

      - uses: hashicorp/setup-terraform@651471c36a6092792c552e8b1bef71e592b462d8 # ratchet:hashicorp/setup-terraform@v3

      - run: terraform init
      - run: terraform fmt -check -diff -recursive .

      - name: Plan Terraform
        id: plan
        continue-on-error: true
        run: terraform plan -input=false -no-color


      - run: echo ${{ steps.plan.outputs.stdout }}
      - run: echo ${{ steps.plan.outputs.stderr }}
      - run: echo ${{ steps.plan.outputs.exitcode }}

